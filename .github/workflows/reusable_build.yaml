name: Reusable Docker Build or Retag

on:
  workflow_call:
    inputs:
      targets:
        description: "Comma-separated list of build targets (e.g., dev,beta,stable)"
        required: true
        type: string
      docker_tag_suffix:
        description: "Suffix to append to the Docker tag (e.g., 'pr' for pull requests)"
        required: false
        type: string
      retag:
        description: "Set to true for retagging existing images"
        required: false
        type: boolean

jobs:
  build-or-retag:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        target: ${{ fromJson(inputs.targets) }}

    steps:
      - name: Checkout the PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER_NAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Extract Version and Construct Tag
        id: extract_version_and_tag
        run: |
          capitalize() {
            echo "$1" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}'
          }
          CAPITALIZED_TARGET=$(capitalize "${{ matrix.target }}")
          CONFIG_FILE="Omada ${CAPITALIZED_TARGET}/config.yaml"
          VERSION=$(yq '.version' "${CONFIG_FILE}")

          if [ -n "${{ inputs.docker_tag_suffix }}" ]; then
            DOCKER_TAG="${VERSION}-${{ inputs.docker_tag_suffix }}"
          else
            DOCKER_TAG="${VERSION}"
          fi

          echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "DOCKER_IMAGE=${{ secrets.DOCKER_USER_NAME }}/home-assistant-omada" >> $GITHUB_ENV
          echo "DOCKER_TAG=$DOCKER_TAG" >> $GITHUB_ENV

          echo "Config file: $CONFIG_FILE"
          echo "Version: $VERSION"
          echo "Docker Image: $DOCKER_IMAGE"
          echo "Docker Tag: $DOCKER_TAG"

      - name: Check if Final Tag Exists
        if: inputs.retag == true
        id: check_existing_tag
        run: |
          IMAGE="${{ env.DOCKER_IMAGE }}-${{ matrix.target }}:${{ env.VERSION }}"

          echo "Checking if image exists: $IMAGE"
          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
            echo "Image exists: $IMAGE"
            echo "SKIP_RETAG=true" >> $GITHUB_ENV
          else
            echo "Image does not exist: $IMAGE"
            echo "SKIP_RETAG=false" >> $GITHUB_ENV
          fi

      - name: Retag and Push Multi-Arch Docker Image
        if: inputs.retag == true && env.SKIP_RETAG == 'false'
        run: |
          SOURCE_IMAGE="${{ env.DOCKER_IMAGE }}-${{ matrix.target }}:${{ env.DOCKER_TAG }}"
          TARGET_IMAGE="${{ env.DOCKER_IMAGE }}-${{ matrix.target }}:${{ env.VERSION }}"
          docker buildx imagetools create -t "$TARGET_IMAGE" "$SOURCE_IMAGE"

      - name: Build and Push Docker Image
        if: inputs.retag != true
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}-${{ matrix.target }}:${{ env.DOCKER_TAG }}
          platforms: linux/amd64,linux/arm64
          file: ./Omada Dev/Dockerfile
          context: ./Omada Dev
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}-${{ matrix.target }}:cache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}-${{ matrix.target }}:cache,mode=max
          build-args: |
            INSTALL_VER=${{ env.VERSION }}
